<script>
    // ============================================
    // SYST√àME DE PAIEMENT S√âCURIS√â
    // ============================================
    
    // √âtat initial
    let simulationsRestantes = 3;
    let isPremium = false;
    let premiumExpiration = null;
    
    // V√©rifier le statut premium depuis le serveur (simul√© ici)
    function checkPremiumStatus() {
        const premiumData = localStorage.getItem('rentapro_premium');
        if (premiumData) {
            try {
                const data = JSON.parse(premiumData);
                // V√©rifier si le premium est toujours valide
                if (data.expiration && new Date(data.expiration) > new Date()) {
                    isPremium = true;
                    premiumExpiration = data.expiration;
                } else {
                    // Premium expir√©
                    localStorage.removeItem('rentapro_premium');
                    isPremium = false;
                }
            } catch (e) {
                // Donn√©es corrompues
                localStorage.removeItem('rentapro_premium');
            }
        }
        
        // V√©rifier aussi les essais gratuits
        const trialData = localStorage.getItem('rentapro_trials');
        if (trialData) {
            try {
                const data = JSON.parse(trialData);
                // R√©initialiser si c'est un nouveau jour
                const lastReset = new Date(data.lastReset);
                const today = new Date();
                if (lastReset.toDateString() !== today.toDateString()) {
                    // Nouveau jour : r√©initialiser les essais
                    simulationsRestantes = 3;
                    localStorage.setItem('rentapro_trials', JSON.stringify({
                        count: 3,
                        lastReset: today.toISOString()
                    }));
                } else {
                    simulationsRestantes = data.count;
                }
            } catch (e) {
                simulationsRestantes = 3;
            }
        } else {
            // Premier d√©marrage
            localStorage.setItem('rentapro_trials', JSON.stringify({
                count: 3,
                lastReset: new Date().toISOString()
            }));
        }
    }
    
    // Mettre √† jour l'affichage
    function updateDisplay() {
        const trialSpan = document.getElementById('trialCount');
        const calculBtn = document.getElementById('calculBtn');
        const saveBtn = document.getElementById('saveBtn');
        const premiumBanner = document.getElementById('premiumBanner');
        
        if (isPremium) {
            trialSpan.textContent = '‚àû';
            trialSpan.style.color = '#eab308';
            trialSpan.style.fontWeight = 'bold';
            calculBtn.disabled = false;
            saveBtn.disabled = false;
            if (premiumBanner) premiumBanner.style.display = 'none';
            
            // Afficher un message de bienvenue premium
            const expiryDate = premiumExpiration ? new Date(premiumExpiration).toLocaleDateString() : '√† vie';
            console.log(`‚úÖ Mode Premium actif jusqu'au ${expiryDate}`);
        } else {
            trialSpan.textContent = simulationsRestantes;
            trialSpan.style.color = '';
            trialSpan.style.fontWeight = '';
            calculBtn.disabled = simulationsRestantes <= 0;
            saveBtn.disabled = simulationsRestantes <= 0;
            if (premiumBanner) premiumBanner.style.display = 'block';
        }
    }
    
    // Fonction de calcul (inchang√©e)
    function calculer() {
        // V√©rifier les droits d'acc√®s
        if (!isPremium && simulationsRestantes <= 0) {
            alert('‚ùå Vous avez utilis√© vos 3 simulations gratuites.\n\n' +
                  'Pour continuer √† utiliser le simulateur, choisissez une formule Premium ci-dessous !');
            document.getElementById('premiumBanner').scrollIntoView({ behavior: 'smooth' });
            return;
        }
        
        // R√©cup√©ration des valeurs
        const prixAchat = parseFloat(document.getElementById('prixAchat').value) || 0;
        const fraisNotaire = parseFloat(document.getElementById('fraisNotaire').value) || 0;
        const travaux = parseFloat(document.getElementById('travaux').value) || 0;
        const apport = parseFloat(document.getElementById('apport').value) || 0;
        const taux = parseFloat(document.getElementById('taux').value) || 0;
        const duree = parseFloat(document.getElementById('duree').value) || 0;
        const loyer = parseFloat(document.getElementById('loyer').value) || 0;
        const charges = parseFloat(document.getElementById('charges').value) || 0;
        const taxeFonciere = parseFloat(document.getElementById('taxeFonciere').value) || 0;
        const vacance = parseFloat(document.getElementById('vacance').value) || 0;
        const tauxImposition = parseFloat(document.getElementById('tauxImposition').value) || 30;

        // Calculs
        const fraisMontant = prixAchat * (fraisNotaire / 100);
        const totalAcquisition = prixAchat + fraisMontant + travaux;
        const montantEmprunt = totalAcquisition - apport;

        // Mensualit√©
        let mensualite = 0;
        if (montantEmprunt > 0 && taux > 0 && duree > 0) {
            const tauxMensuel = taux / 100 / 12;
            const nbMois = duree * 12;
            mensualite = montantEmprunt * tauxMensuel * Math.pow(1 + tauxMensuel, nbMois) / (Math.pow(1 + tauxMensuel, nbMois) - 1);
        }

        // Revenus et charges
        const loyerAnnuel = loyer * 12;
        const chargesAnnuel = charges * 12;
        const perteVacance = loyerAnnuel * (vacance / 100);
        const revenusNetsAnnuel = loyerAnnuel - chargesAnnuel - perteVacance - taxeFonciere;
        const cashflowMensuel = (revenusNetsAnnuel / 12) - mensualite;

        // Rendements
        const rendementBrut = (loyerAnnuel / prixAchat) * 100;
        const rendementNet = (revenusNetsAnnuel / totalAcquisition) * 100;
        const rendementNetNet = rendementNet * (1 - tauxImposition/100);

        // Retour sur investissement
        const retourInvestissement = apport > 0 ? apport / (revenusNetsAnnuel - mensualite * 12) : 0;

        // Affichage
        document.getElementById('totalAchat').innerText = '$' + totalAcquisition.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        document.getElementById('montantEmprunte').innerText = '$' + montantEmprunt.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        document.getElementById('mensualite').innerText = '$' + mensualite.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        document.getElementById('revenusNets').innerText = '$' + revenusNetsAnnuel.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        document.getElementById('cashflow').innerText = '$' + cashflowMensuel.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        document.getElementById('rendementBrut').innerText = rendementBrut.toFixed(2) + '%';
        document.getElementById('rendementNet').innerText = rendementNet.toFixed(2) + '%';
        document.getElementById('rendementNetNet').innerText = rendementNetNet.toFixed(2) + '%';
        document.getElementById('retourInvestissement').innerText = retourInvestissement.toFixed(1) + ' ans';

        // Coloration cash-flow
        const cashflowSpan = document.getElementById('cashflow');
        if (cashflowMensuel < 0) {
            cashflowSpan.classList.add('negative');
            cashflowSpan.classList.remove('positive');
        } else {
            cashflowSpan.classList.add('positive');
            cashflowSpan.classList.remove('negative');
        }

        // D√©cr√©menter les essais si pas premium
        if (!isPremium) {
            simulationsRestantes--;
            // Sauvegarder dans localStorage
            const trialData = {
                count: simulationsRestantes,
                lastReset: new Date().toISOString()
            };
            localStorage.setItem('rentapro_trials', JSON.stringify(trialData));
            updateDisplay();
            
            if (simulationsRestantes === 0) {
                alert('‚úÖ Vous avez utilis√© vos 3 simulations gratuites.\n\n' +
                      '‚ú® Passez √† Premium pour continuer √† utiliser le simulateur sans limitation !');
            }
        }
    }
    
    // Fonction de sauvegarde
    function sauvegarderSimulation() {
        if (!isPremium) {
            alert('‚ùå La sauvegarde des simulations est r√©serv√©e aux membres Premium.\n\n' +
                  'Passez √† Premium pour sauvegarder vos simulations et y acc√©der plus tard !');
            return;
        }
        alert('‚úÖ Simulation sauvegard√©e ! (Fonctionnalit√© Premium)');
    }
    
    // FONCTION D'ACHAT S√âCURIS√âE (plus de bug)
    function acheterPremium(type) {
        // D√©finir les prix
        let montant, duree, libelle;
        
        switch(type) {
            case 'monthly':
                montant = 2.99;
                duree = 30; // jours
                libelle = 'Mensuel';
                break;
            case 'yearly':
                montant = 29.99;
                duree = 365; // jours
                libelle = 'Annuel';
                break;
            case 'lifetime':
                montant = 49.99;
                duree = 36500; // ~100 ans
                libelle = '√Ä vie';
                break;
            default:
                return;
        }
        
        // Simuler une v√©rification de paiement (√Ä REMPLACER par vrai PayPal)
        const confirmation = confirm(
            `üîí Redirection vers PayPal\n\n` +
            `Formule choisie : ${libelle}\n` +
            `Montant : ${montant}$\n\n` +
            `Cliquez sur OK pour simuler un paiement r√©ussi.\n` +
            `(En production, ceci serait un vrai paiement PayPal)`
        );
        
        if (confirmation) {
            // Calculer la date d'expiration
            const expiration = new Date();
            expiration.setDate(expiration.getDate() + duree);
            
            // Sauvegarder le statut premium AVEC date d'expiration
            const premiumData = {
                active: true,
                type: type,
                expiration: expiration.toISOString(),
                purchaseDate: new Date().toISOString()
            };
            
            localStorage.setItem('rentapro_premium', JSON.stringify(premiumData));
            
            // Mettre √† jour l'√©tat
            isPremium = true;
            premiumExpiration = expiration.toISOString();
            
            // Mettre √† jour l'affichage
            updateDisplay();
            
            // Message de confirmation
            const expiryDate = expiration.toLocaleDateString();
            alert(`üéâ F√âLICITATIONS !\n\n` +
                  `Vous √™tes maintenant membre Premium (formule ${libelle}).\n` +
                  `Acc√®s illimit√© jusqu'au ${expiryDate}.\n\n` +
                  `Merci pour votre soutien ! üôè`);
        } else {
            alert('‚ùå Paiement annul√©. Vous pouvez r√©essayer quand vous voulez.');
        }
    }
    
    // Initialisation
    checkPremiumStatus();
    updateDisplay();
    
    // Calcul automatique au chargement (ne compte pas comme essai)
    window.onload = function() {
        if (isPremium || simulationsRestantes > 0) {
            calculer();
        }
    };
    
    // Pour le d√©bogage (optionnel, √† retirer en production)
    console.log('Statut Premium:', isPremium);
    console.log('Simulations restantes:', simulationsRestantes);
</script>
